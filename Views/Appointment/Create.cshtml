@model WebProject.Models.Appointment

@{
    Layout = "_Layout"; // Varsayılan layout
}

<div class="container d-flex justify-content-center align-items-center" style="min-height: 100vh;">
    <div class="card p-4" style="background-color: #333; color: white; width: 400px;">
        <h2 class="text-center">@ViewBag.ServiceName</h2>
        <p>Salon: @ViewBag.Salon.Name</p>
        <p>Price: @ViewBag.ServicePrice</p>
        <p>Duration: @ViewBag.ServiceDuration</p>

        <h3>Select Your Appointment</h3>

        <form method="post">
            <div class="form-group">
                <label for="employeeSelect">Choose Barber:</label>
                <select id="employeeSelect" name="employeeId" class="form-control">
                    <option value="">Select a barber</option>
                    @foreach (var employee in ViewBag.Employees)
                    {
                        <option value="@employee.EmployeeId">@employee.Name</option>
                    }
                </select>
            </div>

            <div class="form-group mt-3">
                <label for="dateSelect">Choose Date:</label>
                <div id="dateButtons" class="btn-group-vertical w-100">
                    <button type="button" class="btn btn-secondary mb-2" disabled>Select a date</button>
                </div>
                <!-- Hidden input for selected date -->
                <input type="hidden" id="appointmentDate" name="appointmentDate" />
            </div>

            <div class="form-group mt-3">
                <label for="timeSelect">Choose Time:</label>
                <div id="timeButtons" class="btn-group-vertical w-100">
                    <button type="button" class="btn btn-secondary mb-2" disabled>Select a time</button>
                </div>
                <!-- Hidden input for selected time -->
                <input type="hidden" id="appointmentTime" name="appointmentTime" />
            </div>

            <button type="submit" class="btn btn-primary btn-block mt-4">Book Appointment</button>
        </form>
    </div>
</div>

<!-- Pop-up container -->
<div id="popup" class="popup" style="display:none;">
    <div class="popup-content">
        <p id="popupMessage"></p>
        <button onclick="closePopup()">Close</button>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        $('#employeeSelect').on('change', function () {
            const employeeId = $(this).val();
            if (employeeId) {
                $.ajax({
                    url: `/Appointment/GetAvailableDates?employeeId=${employeeId}&serviceId=@ViewBag.ServiceId`,
                    method: 'POST',
                    success: function (data) {
                        const dateButtons = $('#dateButtons');
                        dateButtons.empty(); // Clear previous buttons
                        if (data && data.length > 0) {
                            data.forEach(function (date) {
                                dateButtons.append(`<button type="button" class="btn btn-outline-light mb-2" data-date="${date}">${date}</button>`);
                            });
                            $('#timeButtons').html('<button type="button" class="btn btn-secondary mb-2" disabled>Select a time</button>');
                            $('#dateButtons button').on('click', function () {
                                $('#dateButtons button').removeClass('btn-primary').addClass('btn-outline-light');
                                $(this).removeClass('btn-outline-light').addClass('btn-primary');
                                $('#appointmentDate').val($(this).data('date')); // Set hidden field
                                fetchAvailableTimes(employeeId, $(this).data('date'));
                            });
                        } else {
                            alert("No available dates for this barber.");
                        }
                    },
                    error: function () {
                        alert('Error fetching available dates. Please try again.');
                    }
                });
            } else {
                $('#dateButtons').html('<button type="button" class="btn btn-secondary mb-2" disabled>Select a date</button>');
                $('#timeButtons').html('<button type="button" class="btn btn-secondary mb-2" disabled>Select a time</button>');
                $('#appointmentDate').val(''); // Reset hidden field
                $('#appointmentTime').val(''); // Reset hidden field
            }
        });

        function fetchAvailableTimes(employeeId, appointmentDate) {
            $.ajax({
                url: `/Appointment/GetAvailableTimes?employeeId=${employeeId}&serviceId=@ViewBag.ServiceId&date=${appointmentDate}`,
                method: 'POST',
                success: function (data) {
                    const timeButtons = $('#timeButtons');
                    timeButtons.empty(); // Clear previous buttons
                    if (data && data.length > 0) {
                        data.forEach(function (time) {
                            timeButtons.append(`<button type="button" class="btn btn-outline-light mb-2" data-time="${time}">${time}</button>`);
                        });
                        $('#timeButtons button').on('click', function () {
                            $('#timeButtons button').removeClass('btn-primary').addClass('btn-outline-light');
                            $(this).removeClass('btn-outline-light').addClass('btn-primary');
                            $('#appointmentTime').val($(this).data('time')); // Set hidden field
                        });
                    } else {
                        alert("No available times for this date.");
                    }
                },
                error: function () {
                    alert('Error fetching available times. Please try again.');
                }
            });
        }

        // Randevu başarıyla alındığında pop-up göster
        $("form").on("submit", function (e) {
            e.preventDefault();

            const employeeId = $('#employeeSelect').val();
            const serviceId = '@ViewBag.ServiceId';
            const appointmentDate = $('#appointmentDate').val();
            const appointmentTime = $('#appointmentTime').val();

            if (!employeeId || !appointmentDate || !appointmentTime) {
                alert('Please select all fields.');
                return;
            }

            $.ajax({
                url: '/Appointment/BookAppointment',
                method: 'POST',
                data: {
                    employeeId: employeeId,
                    serviceId: serviceId,
                    appointmentDate: appointmentDate,
                    appointmentTime: appointmentTime
                },
                success: function (response) {
                    if (response.success) {
                        showPopup(response.message);
                    } else {
                        alert(response.message);
                    }
                },
                error: function () {
                    alert('Error booking appointment. Please try again.');
                }
            });
        });
    });

    // Pop-up gösterme
    function showPopup(message) {
        $('#popupMessage').text(message);
        $('#popup').show();
    }

    // Pop-up kapama
    function closePopup() {
        $('#popup').hide();
    }
</script>

<style>
    .popup {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .popup-content {
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        text-align: center;
    }
</style>
